- name: Get local primary group
  ansible.builtin.command: id -gn
  register: local_group
  changed_when: false
  delegate_to: localhost

- name: Ensure tf folder exists on local
  ansible.builtin.file:
    path: "{{ playbook_dir }}/autogenerated/{{ node_hostname }}/LXC/{{ lxc_hostname }}/"
    state: directory
    mode: '0755'
    owner: "{{ lookup('env', 'USER') }}"
    group: "{{ local_group.stdout }}"
  delegate_to: localhost


- name: Template {{ template_tf }}.tf.j2 to {{ lxc_hostname }}.tf
  ansible.builtin.template:
    src: "{{ template_tf }}.tf.j2"
    dest: "{{ playbook_dir }}/autogenerated/{{ node_hostname }}/LXC/{{ lxc_hostname }}/{{ lxc_hostname }}.tf"
    mode: '0644'
  delegate_to: localhost

- name: Create manual_scripts directory if it doesn't exist
  ansible.builtin.file:
    path: "{{ playbook_dir }}/autogenerated/{{ node_hostname }}/LXC/{{ lxc_hostname }}/manual_scripts"
    state: directory
    mode: '0755'
  delegate_to: localhost

- name: Template {{ bootstrap_ansible.sh }}.tf.j2 to bootstrap_ansible.sh
  ansible.builtin.template:
    src: "bootstrap_ansible.sh.j2"
    dest: "{{ playbook_dir }}/autogenerated/{{ node_hostname }}/LXC/{{ lxc_hostname }}/manual_scripts/bootstrap_ansible.sh"
    mode: '0644'
  delegate_to: localhost


- name: Run Terraform for {{ hostname }}
  cloud.terraform.terraform:
    project_path: "{{ playbook_dir }}/autogenerated/{{ node_hostname }}/LXC/{{ lxc_hostname }}"
    state: present
    force_init: true
    provider_upgrade: true
    lock: true
    targets:
      - proxmox_virtual_environment_container.{{ lxc_hostname }}
  delegate_to: localhost
  register: tf_output


- name: Display Terraform output for Docker LXC
  ansible.builtin.debug:
    msg: "{{ tf_output }}"
  delegate_to: localhost  # Added this to run locally

