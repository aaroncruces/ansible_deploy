- name: Check if NVIDIA driver is installed
  ansible.builtin.command: nvidia-smi
  register: nvidia_check
  failed_when: false
  changed_when: false

- name: Call apt prepare to update
  include_role:
    name: common
    tasks_from: apt_prepare.yml
  when: nvidia_check.rc != 0

- name: Get current kernel version
  ansible.builtin.command: uname -r
  changed_when: false
  register: kernel_version
  when: nvidia_check.rc != 0

- name: Set header package fact based on kernel type
  set_fact:
    header_package: "{{ 'proxmox-headers-' + kernel_version.stdout if 'pve' in kernel_version.stdout else 'linux-headers-' + kernel_version.stdout }}"
  when: nvidia_check.rc != 0

- name: Install headers for current kernel
  ansible.builtin.apt:
    name: "{{ header_package }}"
    state: present
    update_cache: true
  when: nvidia_check.rc != 0

- name: Ensure NVIDIA DKMS and related packages are installed on Debian
  ansible.builtin.apt:
    name:
      - nvidia-driver
      - nvidia-kernel-dkms
      - nvidia-vaapi-driver
      - nvidia-settings
    state: present
  become: true
  register: nvidia_packages_installed
  when: nvidia_check.rc != 0

- name: Run DKMS autoinstall to build NVIDIA modules
  ansible.builtin.command:
    cmd: dkms autoinstall
  become: true
  changed_when: false
  when: nvidia_packages_installed.changed

- name: Create blacklist-nouveau.conf to disable Nouveau
  ansible.builtin.copy:
    dest: /etc/modprobe.d/blacklist-nouveau.conf
    content: |
      blacklist nouveau
      options nouveau modeset=0
    owner: root
    group: root
    mode: '0644'
    become: true
  when: nvidia_check.rc != 0

- name: Add NVIDIA modules for early loading in initramfs (including uvm)
  ansible.builtin.lineinfile:
    path: /etc/initramfs-tools/modules
    line: "{{ item }}"
    create: yes
    owner: root
    group: root
    mode: '0644'
  loop:
    - nvidia
    - nvidia_modeset
    - nvidia_uvm
    - nvidia_drm
  when: nvidia_check.rc != 0

- name: Regenerate initramfs to apply Nouveau blacklist and early NVIDIA loading
  ansible.builtin.command:
    cmd: update-initramfs -u -k all
  become: true
  when: nvidia_check.rc != 0
  changed_when: false

- name: Reboot system after NVIDIA driver installation
  ansible.builtin.reboot:
    reboot_timeout: 300
    become: true
  when: nvidia_packages_installed is defined and nvidia_packages_installed.changed